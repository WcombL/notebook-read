# 程序中的错误处理

## 传统的错误检查

**处理错误最直接的方式事通过错误码**

通过函数的返回值标识是否有错，然后通过全局的errno变量配合一个errstr数组来告诉你为什么出错

但是这样的设计会造成以下两个问题：
1. 程序员一不小心就会忘记返回值的检查，而造成代码的BUG
2. 函数接口非常不纯洁，正常值和错误值混淆在一起，导致语义有问题

**返回多个值**

一个标识函数返回值，一个标识错误信息

**异常捕捉处理**

try -- catch -- finally

好处：
- 函数接口在input(入参)和output(返回值)及错误处理的语义是比较清楚的
- 正常逻辑的代码可以与错误处理和资源清理的代码分开，提高了代码的可读性。
- 异常不能被忽略(如果要忽略也需要catch住，这是显式忽略)
- 在面向对象的语言中，异常是个对象，所以，可以实现多态式的catch
- 与状态返回码相比，异常捕捉有一个好处是，函数可以嵌套调用，或是链式调用。

异常捕捉是否对性能有影响，不会。原因如下：
- 异常捕捉的确是对性能有影响的，那是因为一旦异常被抛出，函数也就跟着return了。而程序在执行
  需要处理函数栈上的上下文，这会导致性能变得很慢，尤其是函数栈比较深的时候
- 但从另一方面来说，异常的抛出基本上表明程序的错误，程序在绝大多数情况下，应该是在没有异常的情况下运行
  所以，有异常应该是少数的情况，不会影响正常处理的性能问题

缺点(致命问题)：
- 在异步运行的世界里，try语句块里的函数运行在另外一个线程中，其中抛出的异常无法在调用者的这个
  线程中被捕获。


## 错误返回码 vs 异常捕捉

错误分类：
- 资源错误。当我们的代码去请求一些资源时导致的错误，比如打开一个没有权限的文件，
  写文件时出现的写错误，发送文件到网络端发现网络故障的错误，等等
- 程序错误。比如：空指针、非法参数等。要记录下来，写入日志，最好触发监控系统报警
- 用户的错误。比如Bad Request、Bad Format 等这类由用户的不合法输入带来的错误
  需要做统计，统计相应的错误率，这样有利我们改善软件或是侦测是否有恶意的用户请求。

1. 对于我们并不期望会发生的事，我们可以使用异常捕捉；
2. 对于我们觉得可能会发生的事，使用返回码。

只能而选一，以下场景：
- 在 C++ 重载操作符的情况下，你就很难使用错误返回码，只能抛异常；
- 异常捕捉只能在同步的情况下使用，在异步模式下，抛异常这事就不行了，需要通过检查子进程退出码或是回调函数来解决；
- 在分布式的情况下，调用远程服务只能看错误返回码，比如 HTTP 的返回码


## 异步编程世界里的错误处理

在异步编程的世界里，因为被调用的函数是被放到了另外一个线程里运行，这将导致：

- 无法使用返回码。因为函数在被异步运行中，所谓的返回只是把处理权交给下一条指令，
  而不是把函数运行完的结果返回。所以，函数返回的语义完全变了，返回码也没有用了。
- 无法使用抛异常的方式。因为除了上述的函数立马返回的原因之外，抛出的异常也在另外一个线程中，
  不同线程中的栈是完全不一样的，所以主线程的 catch 完全看不到另外一个线程中的异常。

> 最常用的是callback方式。在做异步请求的时候，注册几个 OnSuccess()、 OnFailure() 这样的函数，让在另一个线程中运行的异步代码来回调过来

### JavaScript 异步编程的错误处理

Callback Hell 的问题

一般来说，在异步编程的实践里，我们会用 Promise 模式来处理


### Java 异步编程的 Promise 模式

在 JDK 1.8 里也引入了类—— CompletableFuture。这个类提供了大量的异步编程中 Promise 的各种方式

```Java
CompletableFuture.supplyAsync(this::findReceiver)
  .thenApply(this::sendMsg)
  .thenAccept(this::notify);
```

## 错误处理的最佳实践

- 统一分类的错误字典。
  无论你是使用错误码还是异常捕捉，都需要认真并统一地做好错误的分类。最好是在一个地方定义相关的错误
- 同类错误的定义最好是可以扩展的
- 定义错误的严重程度
- 错误日志的输出最好使用错误码，而不是错误信息
- 忽略错误最好有日志 不然会给维护带来很大的麻烦。
- 对于同一个地方不停的报错，最好不要都打到日志里
  不然这样会导致其它日志被淹没了，也会导致日志文件太大，最好的实践是，打出一个错误以及出现的次数
- 不要用错误处理逻辑来处理业务逻辑
- 对于同类的错误处理，用一样的模式
- 尽可能在错误发生的地方处理错误。因为这样会让调用者变得更简单
- 向上尽可能地返回原始的错误
- 处理错误时，总是要清理已分配的资源
- 不推荐在循环体里处理错误
- 不要把大量的代码都放在一个 try 语句块内
- 为你的错误定义提供清楚的文档以及每种错误的代码示例
- 对于异步的方式，推荐使用 Promise 模式处理错误
- 对于分布式的系统，推荐使用 APM 相关的软件。尤其是使用 Zipkin 这样的服务调用跟踪的分析来关联错误
