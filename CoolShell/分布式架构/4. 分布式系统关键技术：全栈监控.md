# 分布式系统关键技术：全栈监控

首先，我们需要一个全栈系统监控的东西。它就像是我们的眼睛，没有它，我们就不知道系统到底发生了什么，我们将无法管理或是运维整个分布式系统。
所以，这个系统是非常非常关键的

而在分布式或 Cloud Native 的情况下，系统分成多层，服务各种关联，需要监控的东西特别多。没有一个好的监控系统，我们将无法进行自动化运维和资源调度

**监控系统功能**
- 全栈监控
- 关联分析
- 跨系统调用的串联
- 实时报警和自动处置
- 系统性能分析

## 多层体系的监控

所谓全栈监控，其实就是三层监控

- 基础层：监控主机和底层资源。比如：CPU、内存、网络吞吐、硬盘 I/O、硬盘使用等
- 中间层：就是中间件层的监控。比如：Nginx、Redis、ActiveMQ、Kafka、MySQL、Tomcat 等
- 应用层：监控应用层的使用。比如：HTTP 访问的吞吐量、响应时间、返回码，调用链路分析，性能瓶颈，还包括用户端的监控。

![全栈监控](全栈监控.png)

**监控标准化**
- 日志数据结构化
- 监控数据格式标准化
- 统一的监控平台
- 统一的日志分析

## 好监控系统特征

- 关注于整体应用的 SLA(Service-Level Agreement，意思是服务等级协议)。主要从为用户服务的 API 来监控整个系统
- 关联指标聚合。 把有关联的系统及其指标聚合展示
- 快速故障定位

一个好的监控系统主要是为以下两个场景所设计的。  
**体检**
- 容量管理。 提供一个全局的系统运行时数据的展示，可以让工程师团队知道是否需要增加机器或者其它资源。
- 性能管理。可以通过查看大盘，找到系统瓶颈，并有针对性地优化系统和相应代码。

**急诊**
- 定位问题。可以快速地暴露并找到问题的发生点，帮助技术人员诊断问题。
- 性能分析。当出现非预期的流量提升时，可以快速地找到系统的瓶颈，并可以帮助开发人员深入代码。

**好的监控应该实现**
- 服务调用链跟踪 这个监控系统应该从对外的 API 开始，然后将后台的实际服务给关联起来，再将这个服务的依赖服务给关联起来，
  直到最后一个服务（如 MySQL 或 Redis），这样就可以把整个系统的服务全部都串连起来了。
  这个事情的最佳实践是 Google Dapper 系统，其对应于开源的实现是 Zipkin。
  对于 Java 类的服务，我们可以使用字节码技术进行字节码注入，做到代码无侵入式
- 服务调用时长分布。使用 Zipkin, 可以看到一个服务调用链上的时间分布，这样有助于我们知道最耗时的服务是什么
- 服务的 TOP N 视图。所谓 TOP N 视图就是一个系统请求的排名情况。
  一般来说，这个排名会有三种排名的方法：a）按调用量排名，b) 按请求最耗时排名，c）按热点排名（一个时间段内的请求次数的响应时间和）。
- 数据库操作关联。对于 Java 应用，我们可以很方便地通过 JavaAgent 字节码注入技术拿到 JDBC 执行数据库操作的执行时间。
  对此，我们可以和相关的请求对应起来
- 服务资源跟踪。我们的服务可能运行在物理机上，也可能运行在虚拟机里，还可能运行在一个 Docker 的容器里，Docker 容器又运行在物理机或是虚拟机上。
  我们需要把服务运行的机器节点上的数据（如 CPU、MEM、I/O、DISK、NETWORK）关联起来。

> 一个分布式系统，或是一个自动化运维系统，或是一个 Cloud Native 的云化系统，最重要的事就是把监控系统做好。在把数据收集好的同时，更重要的是把数据关联好。这样，我们才可能很快地定位故障，进而才能进行自动化调度。
